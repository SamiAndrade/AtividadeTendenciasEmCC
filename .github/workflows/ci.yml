name: CI - BuscaAnimais

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build do Projeto
    runs-on: windows-latest
    steps:
      - name: Checar o repositório
        uses: actions/checkout@v4
      - name: Configurar .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Restaurar pacotes
        run: dotnet restore
      - name: Build do projeto
        run: dotnet build --configuration Release --no-restore

  sast:
    name: SAST - CodeQL
    runs-on: windows-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checar o repositório
        uses: actions/checkout@v4
      - name: Configurar .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
      - name: Compilar o código
        run: dotnet build --configuration Release
      - name: Executar análise CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"

  dast:
    name: DAST - OWASP ZAP
    runs-on: windows-latest
    needs: build
    steps:
      - name: Checar o repositório
        uses: actions/checkout@v4
      - name: Configurar .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Iniciar aplicação para testes
        run: |
          Start-Process -NoNewWindow -FilePath "dotnet" -ArgumentList "run --project ./Caminho/Para/SeuProjeto/BuscaAnimais.csproj"
          Start-Sleep -Seconds 15
      - name: Baixar e instalar OWASP ZAP
        run: |
          Invoke-WebRequest -Uri "https://github.com/zaproxy/zaproxy/releases/download/v2.16.1/ZAP_2_16_1_windows.exe" -OutFile "ZAP_2_16_1_windows.exe"
          Start-Process -NoNewWindow -FilePath "ZAP_2_16_1_windows.exe" -ArgumentList "/S" -Wait
      - name: Executar varredura OWASP ZAP
        run: |
          & "C:\Program Files\OWASP\Zed Attack Proxy\zap.bat" -cmd -quickurl http://localhost:5000 -quickout zap_report.html
      - name: Upload do relatório ZAP
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap_report.html

